function getName(e){return e.vernacularName||e.canonicalName||e.scientificName||"Error: could not find name"}function getScientificName(e){var t=e.scientificName;if(e.authorship){var a=t.indexOf(e.authorship);if(-1!==a)return t.substring(0,a-1)}return t}function getCommonName(e){return e.vernacularName||e.canonicalName}function setInformationPaneDatum(e){d3.select("#infoContainer").datum(e)}function getSidebarDatum(){return d3.select("#infoContainer").datum()||[-1,!1]}function showInformation(e,t){setUpInformationPanel(),showWikipediaInformation(e,t)}function showWikipediaInformation(e,t){putWikipediaInfoLoader();var a=getScientificName(e),i=getCommonName(e),n=e.id,r=new Wikipedia;r.article(i,a,function(e){removeWikipediaInfoLoader();var o=d3.select("#speciesData");e?(setInformationPaneDatum([n,!0]),addWikipediaTextToSelection(e,t,o),addWikipediaImage(r,i,a,o)):(setInformationPaneDatum([n,!1]),addNoAvailableInformationText(o))})}function addWikipediaImage(e,t,a,i){e.image(t,a,function(e){var t=chooseImage(e||[]);t&&addWikipediaImageToSelection(i,t)})}function addWikipediaImageToSelection(e,t){e.insert("img","#content").attr("src",t).attr("alt","image").attr("class","ui huge image")}function addWikipediaTextToSelection(e,t,a){var i=e.title,n=e.extract,r=removeWikiCruft(n),o=i+" ("+t.getTaxon()+")";a.append("h1").attr("class","header").text(o),a.append("div").attr("id","content").html(r)}function addNoAvailableInformationText(e){e.append("h1").text("No available information")}function removeWikiCruft(e){var t=e.toLowerCase(),a=t.indexOf("see also");if(-1!==a)return e.substring(0,a);var a=t.indexOf("references");if(-1!==a)return e.substring(0,a);var a=t.indexOf("bibliography");return-1!==a?e.substring(0,a):e}function chooseImage(e){for(var t=0;t<e.length;t++){var a=e[t],i=a.title,n=a.imageinfo[0],r=n.mime,o=n.url,l=n.size;if(!containsAny(i,filterList)&&!containsAny(o,filterList)&&-1===r.indexOf("application")&&-1===r.indexOf("tif")&&!(l>=5e6||4e4>=l))return o}}function expandSuperTree(e,t){return t.isAtKingdomLevel()?void console.info("Reached kingdom level. Can't go up."):(removeInformationPanelContent(),hideSidebar(),scrollToTop(),t.setRootToParent(),addRoot(e,t),void t.fetchBasicChildrenInformation(function(a){addChildren(e,t,a)}))}function showChildren(e,t,a){if(a.isAtSpeciesLevel())return void console.info("Reached species level. Can't go down.");var i=e.id,n=getSidebarDatum(),r=n&&n[0],o=n[1];r===i&&o||(scrollToTop(),hideSidebar()),a.setRootToChild(i),addRoot(t,a),a.fetchBasicChildrenInformation(function(n){addChildren(t,a,n),r!==i&&showInformation(e,a)})}function scrollToTop(){$("html, body").animate({scrollTop:0},"fast")}function showSidebar(){$(".sidebar").sidebar("show")}function hideSidebar(){$(".sidebar").sidebar("hide")}function getInformationPanel(){return d3.select("#infoContainer")}function removeInformationPanelContent(){d3.selectAll("#speciesData").remove(),d3.selectAll("#removeIcon").remove()}function collapseInformationPanel(){setInformationPaneDatum([0,!1]),removeInformationPanelContent(),hideSidebar()}function addRemoveIconToInformationPanel(){getInformationPanel().append("div").attr("class","ui black icon button").attr("id","removeIcon").style("margin-top","20px").on("click",collapseInformationPanel).append("i").attr("class","remove icon")}function addSpeciesDataContainer(){getInformationPanel().append("div").attr("id","speciesData")}function setUpInformationPanel(){removeInformationPanelContent(),addRemoveIconToInformationPanel(),addSpeciesDataContainer(),showSidebar()}function putWikipediaInfoLoader(){var e=d3.select("#speciesData").append("div").attr("id","infoLoader").style("width","50%").style("margin","0 auto");e.append("div").attr("class","ui large active inline loader"),e.append("b").style("margin-left","20px").text("Fetching information...")}function removeWikipediaInfoLoader(){d3.select("#speciesData").select("#infoLoader").remove()}function putChildrenLoader(){var e=d3.select("#speciesContainer"),t=verticalBarXPos+barWidth,a=verticalBarLength+100;e.append("div").attr("class","ui active large inline loader").style("position","absolute").style("left",t.toString()+"px").style("top",a.toString()+"px").attr("id","graphLoader")}function removeChildrenLoader(){d3.select("#graphLoader").remove()}function clearSvg(e){e.selectAll("g").remove(),e.selectAll("circle").remove(),e.selectAll("image").remove(),e.selectAll("line").remove()}function clearButtons(){d3.selectAll(".textButton").remove(),d3.select("#rootButton").remove()}function resizeSvg(e,t){resizeSvgHeight(e,t)}function resizeSvgHeight(e,t){var a=Math.max(2*rootCircleRadius,(t.length-1)*heightBetweenChildren),i=2*verticalMargin+verticalBarLength;height=a+i,e.attr("height",height)}function addNoInformationAvailableText(e){e.append("text").attr("x",verticalBarXPos+10).attr("y",verticalMargin+verticalBarLength+35).text("No available information").attr("font-family","sans-serif").attr("font-size","20px").attr("fill","rgb(83, 83, 83)")}function addRootCircle(e,t){var a=createRootDiv(),i=createRootButton(a,e);if(t.isAtKingdomLevel())i.attr("class","active big ui red button").text("Life");else{var n=getName(t.root);i.attr("class","big ui red icon button").text(n),i.append("i").attr("class","level up icon"),createRootInformationButton(a,t)}}function createRootDiv(){return d3.select("#speciesContainer").append("div").style("position","absolute").style("left",rootCircleCenterXPos.toString()+"px").style("top",verticalMargin.toString()+"px").attr("id","rootButton")}function createRootButton(e,t){return e.append("div").on("click",function(){expandSuperTree(t,tree)})}function createRootInformationButton(e,t){return e.append("div").attr("class","big ui green icon button").on("click",function(){showInformation(t.root,t)}).append("i").attr("class","icon info letter")}function addLinesFromRootToVerticalBar(e){e.attr("height");svgSelection.append("line").attr("x1",rootCircleCenterXPos+50).attr("y1",verticalMargin+rootCircleRadius).attr("x2",rootCircleCenterXPos+50).attr("y2",verticalMargin+rootCircleRadius+verticalBarLength).attr("stroke-width",5).attr("stroke","black"),svgSelection.append("line").attr("x1",rootCircleCenterXPos+50).attr("y1",verticalMargin+rootCircleRadius+verticalBarLength).attr("x2",verticalBarXPos).attr("y2",verticalMargin+rootCircleRadius+verticalBarLength).attr("stroke-width",5).attr("stroke","black")}function addVerticalLine(e){var t=e.attr("height");svgSelection.append("line").attr("x1",verticalBarXPos).attr("y1",verticalMargin+verticalBarLength).attr("x2",verticalBarXPos).attr("y2",t-verticalMargin).attr("stroke-width",5).attr("stroke","black")}function addHorizontalBars(e,t){for(var a=0;t>a;a++){var i=a*heightBetweenChildren,n=i+verticalMargin+verticalBarLength;e.append("line").attr("x1",verticalBarXPos).attr("y1",n).attr("x2",verticalBarXPos+barWidth).attr("y2",n).attr("stroke-width",5).attr("stroke","black")}}function addChildrenTextButton(e,t,a){var i=d3.select("#speciesContainer"),n=i.selectAll(".textButton").data(t).enter().append("div"),r=verticalBarXPos+barWidth;n.style("position","absolute").style("left",r.toString()+"px").style("top",function(e,t){var a=t*heightBetweenChildren+verticalBarLength+8;return a.toString()+"px"}).attr("class","textButton"),addTextToButtons(n,e,a),addIconToButtons(n,a)}function addTextToButtons(e,t,a){var i=a.isAtSpeciesLevel(),n=e.append("div");i?n.attr("class","ui active blue button"):(n.attr("class","ui blue labeled icon button"),n.on("click",function(e){showChildren(e,t,a)})),n.text(function(e){var t=getName(e);return capitalise(t)}).style("width",function(e){var t=getName(e),a=Math.max(200,12*t.length+90);return a.toString()+"px"}),i||n.append("i").attr("class","level down icon")}function addIconToButtons(e,t){e.append("div").attr("class","ui green icon button").on("click",function(e){showInformation(e,t)}).append("i").attr("class","icon info letter")}function sortByNumberDescendants(e){return e.sort(function(e,t){var a=e.numDescendants||0,i=t.numDescendants||0;return a>i?-1:i>a?1:0})}function addChildrenToSvg(e,t,a){var i=e.append("g").attr("id","childrenGroup"),n=a.length;0===n?addNoInformationAvailableText(i):(a=sortByNumberDescendants(a),addHorizontalBars(i,n),addChildrenTextButton(e,a,t))}function addRoot(e,t){clearSvg(e),clearButtons(),addRootCircle(e,t),addLinesFromRootToVerticalBar(e),putChildrenLoader()}function addChildren(e,t,a){removeChildrenLoader(),resizeSvg(e,a),addVerticalLine(e),addChildrenToSvg(e,t,a)}var wikipediaImages=["logo","red pencil","wikibooks","feature","star","symbol","vote","icon","question_book","disamb","edit","ambox","wiki_letter","speakerlink"],portalImages=["caribou from wagon trails","rose amber","france loiret","Leaf_1_web","Martinique.web"],unwantedImages=["map"],filterList=_.union(wikipediaImages,portalImages,unwantedImages),width=1e3,height=500,rootCircleRadius=30,rootCircleCenterXPos=30,verticalBarLength=100,verticalMargin=30,horizontalOffset=150,verticalBarXPos=rootCircleCenterXPos+rootCircleRadius+horizontalOffset,barWidth=100,heightBetweenChildren=100,selection=d3.select("#speciesContainer"),svgSelection=selection.append("svg").attr("width",width).attr("height",height),body=d3.select("body"),windowWidth=$(window).width();windowWidth>1e3?body.insert("div","#speciesContainer").attr("id","infoContainer").attr("class","ui right very wide sidebar verticalLine"):body.insert("div",".ui.info.message").attr("id","infoContainer");var tree=new Tree;addRoot(svgSelection,tree),tree.fetchBasicChildrenInformation(function(e){addChildren(svgSelection,tree,e)});
